<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>攝像頭拍照框框</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #camera-container {
            display: flex;
            justify-content: center;
            position: relative;
            width: 400px;
            height: 400px;
            max-width: 100%;
            max-height: 100%;
            border: 5px solid #000;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #video {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            transform: rotateY(180deg);
        }

        /* 拍照框的樣式 */
        #capture-box {
            position: absolute;
            top: 60px;
            left: 25%;
            /* 根據需求調整位置 */
            width: 200px;
            height: 270px;
            border: 2px dashed red;
            border-radius: 50%;
            /* 橢圓框 */
        }

        .vertical-line {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            border-left: 2px dashed red;
        }

        #snap {
            display: block;
            margin: 20px auto;
            background-color: #28a745;
            color: white;
        }
    </style>
</head>

<body>
    <!--導覽列-->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark sticky-top shadow-sm">
        <!--mx, my調nav大小-->
        <div class="container-fluid my-1 mx-lg-5">
            <a class="navbar-brand d-flex align-items-center" href="/index">
                <?xml version="1.0" encoding="UTF-8"?><svg class="mx-2 mx-md-4" width="30px" height="30px"
                    stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                    color="#ffffff">
                    <path d="M7 3H5C3.89543 3 3 3.89543 3 5V7" stroke="#ffffff" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M17 3H19C20.1046 3 21 3.89543 21 5V7" stroke="#ffffff" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M16 8L16 10" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M8 8L8 10" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M9 16C9 16 10 17 12 17C14 17 15 16 15 16" stroke="#ffffff" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M12 8L12 13L11 13" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M7 21H5C3.89543 21 3 20.1046 3 19V17" stroke="#ffffff" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M17 21H19C20.1046 21 21 20.1046 21 19V17" stroke="#ffffff" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>能「顏」善「辨」
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01"
                aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">


                <!-- me-auto：向左靠，ms-auto：向右靠 -->
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <!-- me-3：Home和判斷臉型的距離-->
                    <li class="nav-item me-3">
                        <!-- active, aria-current="page"表示當前頁面 -->
                        <a class="nav-link active" aria-current="page" href="/">判斷臉型</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link" href="#">臉型介紹</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!--拍照-->
    <div class="text-center">
        <h1 class="mt-3">拍照</h1>
        <p>請將臉置於橢圓虛線中</p>
        <div id="camera-container">
            <video id="video" autoplay></video>
            <div id="capture-box"></div> <!-- 紅色虛線框框 -->
            <div class="vertical-line"></div> <!-- 新增垂直虛線 -->

        </div>
        <button id="snap" class="btn btn-primary">拍照</button>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapButton = document.getElementById('snap');
        localStorage.clear();

        // 啟動攝像頭
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                alert("無法訪問攝像頭: " + error.message);
                console.error("無法訪問攝像頭: ", error);
            });

        // 拍照功能
        snapButton.addEventListener('click', async () => {
            try {
                const context = canvas.getContext('2d');

                // 設定目標寬度
                const targetWidth = 504;

                // 根據影像的寬高比來計算目標高度
                const aspectRatio = video.videoHeight / video.videoWidth;
                const targetHeight = targetWidth * aspectRatio;

                // 設定 canvas 的寬度和高度
                canvas.width = targetWidth;
                canvas.height = targetHeight;

                // 為了實現鏡像反轉，先進行縮放和移動操作
                context.scale(-1, 1); // 水平翻轉
                context.translate(-canvas.width, 0); // 將畫布從左移動到右

                // 繪製影像到 canvas，保持比例
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 生成 Blob
                const blob = await new Promise((resolve) => {
                    canvas.toBlob(resolve, 'image/jpeg'); // 確保生成 JPEG 格式的圖片 Blob
                });

                // 將 Blob 作為 FormData 進行上傳
                const formData = new FormData();
                formData.append('image', blob, 'photo.jpg');

                // 檢查 CSRF Token
                const csrfToken = document.querySelector('meta[name="csrf-token"]');

                // 發送請求
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': csrfToken.getAttribute('content'), // 如果需要 CSRF Token
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '上傳發生未知錯誤');
                }

                const data = await response.json();
                if (data.image_path) {
                    localStorage.removeItem('capturedImagePath');  // 清除已經使用的圖片路徑
                    localStorage.setItem('capturedImagePath', data.image_path);
                    window.location.href = "/";
                } else {
                    console.error("上傳失敗，無法獲取圖片路徑");
                }
            } catch (error) {
                alert('發生錯誤: ' + error.message);
                console.error('發生錯誤:', error);
            }
        });

    </script>

</body>

</html>